<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AXCELIS 파트검색</title>
    
    <!-- PWA 설정 -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AXCELIS 파트검색">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA 매니페스트 -->
    <link rel="manifest" href="./manifest.json">
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E🔍%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E🔍%3C/text%3E%3C/svg%3E">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/papaparse@5/papaparse.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top, 0px));
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            position: relative;
        }
        
        .title {
            font-size: 2.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 25px;
        }
        
        .github-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #24292e 0%, #4f46e5 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .upload-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .upload-section:hover {
            border-color: #2563eb;
            transform: translateY(-2px);
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }
        
        .status-info {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .status-sample {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-uploaded {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-restored {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .search-box {
            margin: 25px 0;
        }
        
        .search-input {
            width: 100%;
            padding: 18px 24px;
            font-size: 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            outline: none;
            transition: all 0.3s ease;
            background: white;
        }
        
        .search-input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .search-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-google {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        }
        
        .btn-google:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
        }
        
        .btn-image {
            background: linear-gradient(135deg, #ea4335 0%, #fbbc04 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(234, 67, 53, 0.3);
        }
        
        .btn-image:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(234, 67, 53, 0.4);
        }
        
        .stats {
            text-align: center;
            margin: 25px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            font-weight: 600;
            color: #374151;
        }
        
        .results {
            display: grid;
            gap: 20px;
        }
        
        .part-item {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-left: 5px solid #2563eb;
        }
        
        .part-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }
        
        .part-number {
            font-size: 1.5rem;
            font-weight: 800;
            color: #2563eb;
            margin-bottom: 10px;
        }
        
        .part-name {
            font-size: 1.2rem;
            color: #374151;
            margin-bottom: 20px;
            font-weight: 600;
            line-height: 1.4;
        }
        
        .part-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .detail-item {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #e2e8f0;
        }
        
        .detail-label {
            color: #6b7280;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-value {
            color: #374151;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .detail-price {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
            border-left-color: #22c55e;
        }
        
        .detail-category {
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
            color: #7c3aed;
            border-left-color: #8b5cf6;
        }
        
        .detail-location {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            color: #059669;
            border-left-color: #10b981;
        }
        
        .part-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 0.85rem;
        }
        
        .no-results {
            text-align: center;
            padding: 60px 30px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .no-results h3 {
            color: #374151;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .no-results p {
            color: #6b7280;
            margin-bottom: 25px;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2563eb;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.4);
            cursor: pointer;
            z-index: 1000;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .install-prompt:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 25px rgba(37, 99, 235, 0.5);
        }
        
        @media (max-width: 768px) {
            .container { 
                padding: 15px; 
                padding-top: max(15px, env(safe-area-inset-top, 0px));
            }
            .header { padding: 25px; }
            .title { font-size: 2.2rem; }
            .search-buttons { flex-direction: column; align-items: center; }
            .part-details { grid-template-columns: 1fr; }
            .part-actions { justify-content: center; }
            .install-prompt { 
                bottom: max(20px, env(safe-area-inset-bottom, 0px));
                left: 20px;
                right: 20px;
                transform: none;
                text-align: center;
            }
            .github-badge {
                position: static;
                display: inline-block;
                margin-bottom: 15px;
            }
        }
        
        @media (display-mode: standalone) {
            .github-badge::after {
                content: " (앱모드)";
                color: #22c55e;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const PartSearchApp = () => {
            const [searchTerm, setSearchTerm] = useState('');
            const [parts, setParts] = useState([]);
            const [loading, setLoading] = useState(false);
            const [dataSource, setDataSource] = useState('sample');
            const [showInstallPrompt, setShowInstallPrompt] = useState(false);
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            
            // PWA 설치 프롬프트 처리
            useEffect(() => {
                const handleBeforeInstallPrompt = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                    setShowInstallPrompt(true);
                };
                
                window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                
                // 이미 설치된 경우 숨기기
                if (window.matchMedia('(display-mode: standalone)').matches) {
                    setShowInstallPrompt(false);
                }
                
                return () => {
                    window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                };
            }, []);
            
            const handleInstallClick = async () => {
                if (!deferredPrompt) return;
                
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    setShowInstallPrompt(false);
                }
                setDeferredPrompt(null);
            };
            
            // CSV 파일 업로드 처리
            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                console.log('파일 선택됨:', file.name, '크기:', (file.size/1024/1024).toFixed(2) + 'MB', '타입:', file.type);
                
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    alert('❌ CSV 파일만 업로드 가능합니다.');
                    return;
                }
                
                // 대용량 파일 경고 (모바일 최적화)
                if (file.size > 5 * 1024 * 1024) { // 5MB 초과
                    if (!confirm('📱 대용량 파일입니다. 모바일에서는 처리가 느릴 수 있습니다. 계속하시겠습니까?')) {
                        return;
                    }
                }
                
                setLoading(true);
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    try {
                        console.log('파일 읽기 완료, 파싱 시작...');
                        const csvContent = e.target.result;
                        console.log('파일 내용 미리보기:', csvContent.substring(0, 500));
                        
                        // 여러 인코딩과 구분자 시도
                        const parseOptions = [
                            { header: true, skipEmptyLines: true, delimiter: ',', dynamicTyping: false },
                            { header: true, skipEmptyLines: true, delimiter: ';', dynamicTyping: false },
                            { header: true, skipEmptyLines: true, delimiter: '\t', dynamicTyping: false }
                        ];
                        
                        let parsedData = null;
                        let usedDelimiter = '';
                        
                        for (let options of parseOptions) {
                            try {
                                const testParse = Papa.parse(csvContent, options);
                                if (testParse.data.length > 0 && testParse.meta.fields.length > 5) {
                                    parsedData = testParse;
                                    usedDelimiter = options.delimiter;
                                    break;
                                }
                            } catch (e) {
                                console.log('파싱 시도 실패:', options.delimiter);
                            }
                        }
                        
                        if (!parsedData) {
                            throw new Error('적절한 구분자를 찾을 수 없습니다.');
                        }
                        
                        console.log('파싱 완료! 구분자:', usedDelimiter, '데이터 개수:', parsedData.data.length);
                        console.log('컬럼명:', parsedData.meta.fields);
                        
                        // 컬럼명 매핑 (수정된 영문 헤더 기준)
                        const getFieldValue = (row, ...fieldNames) => {
                            for (let fieldName of fieldNames) {
                                if (row[fieldName] !== undefined && row[fieldName] !== null && row[fieldName] !== '') {
                                    // 문자열로 변환하고 앞뒤 공백 제거
                                    const value = String(row[fieldName]).trim();
                                    if (value !== 'null' && value !== 'undefined' && value !== '') {
                                        return value;
                                    }
                                }
                            }
                            return '';
                        };
                        
                        // 실제 컬럼명 확인 및 매핑
                        const fields = parsedData.meta.fields;
                        console.log('실제 컬럼명들:', fields);
                        
                        // 수정된 영문 헤더에 맞춘 컬럼 매핑
                        const findColumn = (searchTerms) => {
                            return fields.find(field => 
                                searchTerms.some(term => 
                                    field.toLowerCase().includes(term.toLowerCase()) ||
                                    field.includes(term) ||
                                    field.trim() === term
                                )
                            );
                        };
                        
                        const partNumberCol = findColumn(['P/N', 'PN', 'Part Number', 'PartNumber']);
                        const partNameCol = findColumn(['DESCRIPTION', 'Description', 'Part Name', 'Name']);
                        const revCol = findColumn(['REV', 'Rev', 'Revision']);
                        const manufacturerCol = findColumn(['MFG', 'Manufacturer', 'Mfg']);
                        const mfgPartCol = findColumn(['MFG P/N', 'MFG_P/N', 'MfgPN', 'Manufacturer Part']);
                        const supplierCol = findColumn(['Vender', 'Vendor', 'Supplier']);
                        const noteCol = findColumn(['Note', 'note', 'Notes', 'Comment', 'Remarks']);
                        const categoryCol = findColumn(['Classification', 'Category', 'Type', 'Class']);
                        const locationCol = findColumn(['Location', 'Storage', 'Warehouse']);
                        const price24Col = findColumn(['24 Price', '24Price', '2024 Price', 'Price 24']);
                        const price25Col = findColumn(['25 Price', '25Price', '2025 Price', 'Price 25']);
                        
                        console.log('컬럼 매핑 결과:');
                        console.log('P/N:', partNumberCol);
                        console.log('DESCRIPTION:', partNameCol);
                        console.log('REV:', revCol);
                        console.log('MFG:', manufacturerCol);
                        console.log('MFG P/N:', mfgPartCol);
                        console.log('Vender:', supplierCol);
                        console.log('Note:', noteCol);
                        console.log('Classification:', categoryCol);
                        console.log('Location:', locationCol);
                        console.log('24 Price:', price24Col);
                        console.log('25 Price:', price25Col);
                        
                        // 첫 번째 행의 Location 값 확인
                        if (parsedData.data.length > 0) {
                            const firstRow = parsedData.data[0];
                            console.log('첫 번째 행 전체:', firstRow);
                            if (locationCol) {
                                console.log(`Location 컬럼 (${locationCol}) 값:`, firstRow[locationCol]);
                                console.log('Location 값 타입:', typeof firstRow[locationCol]);
                            }
                        }
                        
                        // 모바일 최적화: 배치 처리
                        const batchSize = 100;
                        const totalRows = parsedData.data.length;
                        console.log(`총 ${totalRows}개 데이터를 ${batchSize}개씩 배치 처리합니다...`);
                        
                        let cleanedData = [];
                        
                        for (let i = 0; i < totalRows; i += batchSize) {
                            const batch = parsedData.data.slice(i, i + batchSize);
                            const processedBatch = batch
                                .filter(row => {
                                    const partNumber = partNumberCol ? getFieldValue(row, partNumberCol) : '';
                                    return partNumber && partNumber.length > 0;
                                })
                                .map(row => ({
                                    'P/N': partNumberCol ? getFieldValue(row, partNumberCol) : '',
                                    'DESCRIPTION': partNameCol ? getFieldValue(row, partNameCol) : '',
                                    'REV': revCol ? getFieldValue(row, revCol) : '',
                                    'MFG': manufacturerCol ? getFieldValue(row, manufacturerCol) : '',
                                    'MFG P/N': mfgPartCol ? getFieldValue(row, mfgPartCol) : '',
                                    'Vender': supplierCol ? getFieldValue(row, supplierCol) : '',
                                    'Note': noteCol ? getFieldValue(row, noteCol) : '',
                                    'Classification': categoryCol ? getFieldValue(row, categoryCol) : '',
                                    'Location': locationCol ? getFieldValue(row, locationCol) : '',
                                    '24 Price': price24Col ? getFieldValue(row, price24Col) : '',
                                    '25 Price': price25Col ? getFieldValue(row, price25Col) : '',
                                    // 추가 데이터 (검색용, 표시 안함)
                                    '대체품여부': getFieldValue(row, '대체품여부', 'Alternative'),
                                    '기존품제조사': getFieldValue(row, '기존품제조사', 'Original Mfg'),
                                    '기존품품번': getFieldValue(row, '기존품품번', 'Original P/N')
                                }));
                            
                            cleanedData = cleanedData.concat(processedBatch);
                            
                            // 진행률 표시
                            const progress = Math.min(100, Math.round(((i + batchSize) / totalRows) * 100));
                            console.log(`처리 진행률: ${progress}% (${cleanedData.length}개 완료)`);
                            
                            // 모바일에서 UI 블로킹 방지를 위한 짧은 대기
                            if (i % (batchSize * 5) === 0) {
                                await new Promise(resolve => setTimeout(resolve, 10));
                            }
                        }
                        
                        console.log('데이터 정리 완료:', cleanedData.length, '개');
                        console.log('첫 번째 데이터 샘플:', cleanedData[0]);
                        
                        if (cleanedData.length === 0) {
                            throw new Error('유효한 데이터가 없습니다. 품번 컬럼을 확인해주세요.');
                        }
                        
                        setParts(cleanedData);
                        setDataSource('uploaded');
                        
                        // 로컬 스토리지에 저장
                        try {
                            localStorage.setItem('axcelis-parts-data', JSON.stringify(cleanedData));
                            localStorage.setItem('axcelis-data-timestamp', Date.now().toString());
                        } catch (e) {
                            console.log('로컬 저장 실패:', e);
                        }
                        
                        alert(`✅ ${cleanedData.length}개의 부품 데이터를 성공적으로 로드했습니다!\n\n컬럼: ${parsedData.meta.fields.join(', ')}`);
                        
                    } catch (error) {
                        console.error('파일 파싱 오류:', error);
                        alert(`❌ 파일을 읽는 중 오류가 발생했습니다.\n\n오류: ${error.message}\n\n파일이 올바른 CSV 형식인지 확인해주세요.`);
                    }
                    setLoading(false);
                };
                
                reader.onerror = (error) => {
                    console.error('파일 읽기 오류:', error);
                    alert('❌ 파일을 읽을 수 없습니다.');
                    setLoading(false);
                };
                
                // UTF-8, EUC-KR 등 다양한 인코딩 시도
                try {
                    reader.readAsText(file, 'utf-8');
                } catch (e) {
                    try {
                        reader.readAsText(file, 'euc-kr');
                    } catch (e2) {
                        reader.readAsText(file);
                    }
                }
            };
            
            // 초기화 (샘플 데이터 + 로컬 스토리지 복원)
            useEffect(() => {
                // 로컬 스토리지에서 데이터 복원 시도
                try {
                    const savedData = localStorage.getItem('axcelis-parts-data');
                    const savedTimestamp = localStorage.getItem('axcelis-data-timestamp');
                    
                    if (savedData && savedTimestamp) {
                        const data = JSON.parse(savedData);
                        const timestamp = parseInt(savedTimestamp);
                        const hoursSinceUpload = (Date.now() - timestamp) / (1000 * 60 * 60);
                        
                        if (data.length > 0 && hoursSinceUpload < 24) { // 24시간 이내
                            setParts(data);
                            setDataSource('restored');
                            console.log('로컬 데이터 복원 완료:', data.length, '개');
                            return;
                        }
                    }
                } catch (e) {
                    console.log('로컬 데이터 복원 실패:', e);
                }
                
                // 샘플 데이터로 시작
                const sampleData = [
                    {
                        'P/N': '100841',
                        'DESCRIPTION': 'WIRE-HOOKUP, 16GA, VINYL, BLK',
                        'MFG': 'ALPHAWIRE',
                        'MFG P/N': '3077',
                        'Vender': 'Mouser',
                        'Classification': 'General Parts',
                        'Location': 'Warehouse-A1',
                        '24 Price': '3333',
                        '25 Price': '3333',
                        'REV': '',
                        'Note': ''
                    },
                    {
                        'P/N': '510002038',
                        'DESCRIPTION': 'Test Component - Sample Data',
                        'MFG': 'Test Manufacturer',
                        'MFG P/N': 'TEST-001',
                        'Vender': 'Test Supplier',
                        'Classification': 'Special Parts',
                        'Location': 'Warehouse-B2',
                        '24 Price': '10000',
                        '25 Price': '12000',
